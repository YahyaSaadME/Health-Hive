<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medical Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap"
      rel="stylesheet"
    />
  <style>
    /* Reset and Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Lexend", sans-serif;
    }
      .search-container {
        display: flex;
        align-items: center;
        width: 300px;
        background-color: white;
        border: 2px solid #007bff;
        border-radius: 5px;
        padding: 5px;
      }

      .search-input {
        width: 100%;
        padding: 10px;
        border: none;
        outline: none;
        font-size: 16px;
      }

      .search-icon {
        font-size: 18px;
        color: #007bff;
        margin-right: 10px;
      }

      /* Optional: Add some hover effect on the container */
      .search-container:hover {
        border-color: #0056b3;
      }
      /* Reset and Base Styles */
      
      :root {
        --primary-blue: #bad7e9;
        --secondary-blue: #a6cee3;
        --dark-blue: #2b3467;
        --light-gray: #f8fafc;
        --white: #ffffff;
      }

      body,
      html {
        height: 100%;
        background-color: var(--white);
      }

      /* Mobile First Layout */
      .container {
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
      }

      /* Header Styles */
      .menu-toggle {
        display: block;
        position: fixed;
        top: 10px;
        left: 20px;
        z-index: 1000;
        cursor: pointer;
        background: var(--white);
        padding: 5px;
        border-radius: 5px;
      }

      /* Sidebar Styles */
      .sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: var(--light-gray);
        transition: 0.3s;
        z-index: 999;
        padding: 20px;
        overflow-y: auto;
      }

      .sidebar.active {
        left: 0;
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        margin: 20px 0;
      }

      .brand {
        font-weight: 700;
        font-size: 24px;
        color: var(--dark-blue);
      }

      .menu-item {
        display: flex;
        align-items: center;
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .menu-item:hover {
        background-color: var(--primary-blue);
      }

      .menu-item-icon {
        width: 24px;
        height: 24px;
        margin-right: 10px;
        border-radius: 50%;
      }

      /* Chat Area Styles */
      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding-top: 60px; /* Space for fixed header */
      }

      .chat-header {
        position: fixed;
        top: 0;
        width: 100%;
        padding: 15px 20px;
        background: var(--white);
        border-bottom: 1px solid var(--primary-blue);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 998;
      }

      /* Message Container Styles */
      .messages {
        flex: 1;
        padding: 10px;
        background-color: var(--light-gray);
        overflow-y: auto;
      }

      #messageContainer {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .box {
        background: var(--white);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .box h3 {
        color: var(--dark-blue);
        margin-bottom: 10px;
      }

      .box ul {
        padding-left: 20px;
      }

      /* Input Area Styles */
      .chat-input {
        padding: 15px;
        background: var(--white);
        border-top: 1px solid var(--primary-blue);
        display: flex;
        gap: 10px;
      }

      .chat-input input {
        flex: 1;
        padding: 12px;
        border: 1px solid var(--primary-blue);
        border-radius: 8px;
        font-size: 16px;
      }

      .chat-input button {
        padding: 12px 20px;
        background: var(--primary-blue);
        color: var(--dark-blue);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
      }

      /* Loading Spinner */
      .loader {
        border: 4px solid var(--light-gray);
        border-top: 4px solid var(--dark-blue);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Welcome Message */
      #beforeMessage {
        text-align: center;
        padding: 40px 20px;
      }

      #beforeMessage img {
        max-width: 80px;
        margin-bottom: 20px;
      }

      #beforeMessage h4 {
        font-size: 24px;
        margin-bottom: 10px;
      }

      /* Desktop Styles */
      @media (min-width: 768px) {
        .container {
          flex-direction: row;
        }

        .menu-toggle {
          display: none;
        }

        .sidebar {
          position: relative;
          left: 0;
          width: 260px;
          border-right: 1px solid var(--primary-blue);
        }

        .chat-area {
          flex: 1;
          padding-top: 0;
        }

        .chat-header {
          position: relative;
        }

        #messageContainer {
          flex-direction: row;
        }

        #messageContainer > div {
          width: 50%;
        }
      }
      .open-modal-btn:hover {
        background-color: #0056b3;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
      }

      .close-btn:hover {
        color: red;
      }

      .booking-picker {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
      }

      .picker-label {
        font-weight: bold;
        margin-top: 10px;
      }

      .picker-input {
        padding: 8px;
        width: 100%;
        max-width: 300px;
        margin-top: 5px;
        font-size: 16px;
      }

      .booking-button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .booking-button:hover {
        background-color: #0056b3;
      }

      .booking-message {
        text-align: center;
        margin-top: 20px;
        font-size: 18px;
      }

      .unavailable-slot {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="menu-toggle" onclick="toggleSidebar()">☰</div>

      <div class="sidebar">
        <div class="sidebar-header">
          <span class="brand">Medical Assistant</span>
        </div>
        <nav class="nav-menu">
            <a href="/chat/history" style="text-decoration: none">
              <div class="menu-item">
                <img
                  src="https://img.icons8.com/ios-filled/50/000000/alarm.png"
                  alt="Appointments"
                  class="menu-item-icon"
                  style="
                    filter: brightness(0) saturate(100%) invert(30%) sepia(100%)
                      saturate(1700%) hue-rotate(190deg) brightness(95%)
                      contrast(80%);
                  "
                />
                Personal Details
              </div>
              <!-- New AI Chat menu item -->
              <a href="/chat" style="text-decoration: none">
                <div class="menu-item">
                  <img
                    src="https://img.icons8.com/ios-filled/50/000000/chat.png"
                    alt="AI Chat"
                    class="menu-item-icon"
                    style="
                      filter: brightness(0) saturate(100%) invert(30%) sepia(100%)
                        saturate(1700%) hue-rotate(190deg) brightness(95%)
                        contrast(80%);
                    "
                  />
                  AI Chat
                </div>
              </a>
  
              <!-- New Search Doctors menu item -->
              <a href="/search" style="text-decoration: none;">
                <div class="menu-item">
                  <img
                    src="https://img.icons8.com/ios-filled/50/000000/stethoscope.png"
                    alt="Search Doctors"
                    class="menu-item-icon"
                    style="
                      filter: brightness(0) saturate(100%) invert(30%) sepia(100%)
                        saturate(1700%) hue-rotate(190deg) brightness(95%)
                        contrast(80%);
                    "
                  />
                  Search Doctors
                </div>
              </a>
  
              <a href="/chat/history" style="text-decoration: none;">
            <div class="menu-item">
                <img
                  src="https://img.icons8.com/ios-filled/50/000000/medical-history.png"
                  alt="Chat History"
                  class="menu-item-icon"
                  style="
                    filter: brightness(0) saturate(100%) invert(30%) sepia(100%)
                      saturate(1700%) hue-rotate(190deg) brightness(95%)
                      contrast(80%);
                  "
                />
                Medical History
              </div>
          </a>
          <a href="/appoinment" style="text-decoration: none;">
  
            <div class="menu-item">
              <img
                src="https://img.icons8.com/ios-filled/50/000000/alarm.png"
                alt="Appointments"
                class="menu-item-icon"
                style="
                  filter: brightness(0) saturate(100%) invert(30%) sepia(100%)
                    saturate(1700%) hue-rotate(190deg) brightness(95%)
                    contrast(80%);
                "
              />
              Appointments
            </div>
          </a>
  
            <div class="menu-item">
              <img
                src="https://img.icons8.com/ios-filled/50/000000/test-results.png"
                alt="Rrescription Refiller"
                class="menu-item-icon"
                style="
                  filter: brightness(0) saturate(100%) invert(30%) sepia(100%)
                    saturate(1700%) hue-rotate(190deg) brightness(95%)
                    contrast(80%);
                "
              />
              Rrescription Refiller
            </div>
  
            <div class="menu-item">
              <img
                src="https://img.icons8.com/ios-filled/50/000000/logout-rounded.png"
                alt="Logout"
                class="menu-item-icon"
                style="
                  filter: brightness(0) saturate(100%) invert(30%) sepia(100%)
                    saturate(1700%) hue-rotate(190deg) brightness(95%)
                    contrast(80%);
                "
              />
              Logout
            </div>
          </nav>
        <div class="upgrade-box box">
          <h3>Premium Care</h3>
          <p>Upgrade for priority support</p>
        </div>
      </div>

      <div class="chat-area">
        <div class="chat-header">
          <span>Medical Consultation</span>
        </div>
        <!-- <button class="open-modal-btn" onclick="openModal()">
          Book Appointment
        </button> -->

        <div style="display: flex; justify-content: center">
          <div
            class="search-container"
            style="width: 80%; border-radius: 4px; margin: 10px"
          >
            <div style="display: flex; align-items: center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-geo-alt"
                viewBox="0 0 16 16"
                style="width: 50px"
              >
                <path
                  d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A32 32 0 0 1 8 14.58a32 32 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10"
                />
                <path
                  d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4m0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6"
                />
              </svg>
              <div id="locationOutput" class="location-output"></div>
            </div>
            <hr
              style="
                width: 2px;
                border: 1px solid rgb(146, 146, 146);
                height: 70%;
                margin-left: 4px;
              "
            />
            <div style="display: flex; align-items: center">
              <svg
                style="margin-left: 10px"
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-search"
                viewBox="0 0 16 16"
              >
                <path
                  d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"
                />
              </svg>
              <input
                type="text"
                id="search"
                onchange="find()"
                class="search-input"
                placeholder="Search..."
              />
            </div>
          </div>
        </div>
        <ul style="margin: 10px" id="doctors"></ul>
      </div>
    </div>
    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Book Your Appointment</h2>
          <button class="close-btn" onclick="closeModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="booking-picker">
            <label for="appointmentDate" class="picker-label"
              >Select Date:</label
            >
            <input type="date" id="appointmentDate" class="picker-input" />

            <label for="appointmentTime" class="picker-label"
              >Select Time:</label
            >
            <input type="time" id="appointmentTime" class="picker-input" />

            <button id="bookingModalId" class="booking-button">
              Book Appointment
            </button>
          </div>
          <div id="appointmentMessage" class="booking-message"></div>
        </div>
      </div>
    </div>

    <script>
      const find = async () => {
        try {
          const send = await fetch("/doctor/info", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              searchTerm: document.getElementById("search").value,
            }),
          });
          const data = await send.json();
          data.map((e) => {
            document.getElementById("doctors").innerHTML += `          <li
            style="
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
              border-radius: 6px;
              padding: 10px;
            "
          >
            <div style="width: 100%; padding: 10px;display: flex;justify-content: space-between;">
              <div style="margin-right: 10px;">
                <h4>${e.name} , ${e.degrees}</h4>
                <p>fee : ${e.fee}</p>
                <p
                  style="
                    padding: 2px 5px;
                    background-color: rgb(60, 175, 60);
                    color: rgb(255, 255, 255);
                    width: fit-content;
                  "
                >
              ${e.specialization}
                </p>
              </div>
              <div>
                <p>${e.hospital}</p>
                <p>${e.address}</p>
              </div>
            </div>
            <div style="display: flex;justify-content: space-between;align-items: center;padding: 10px;">
                <p>${e.availabilityFrom} - ${e.availabilityTo}</p>
                <button onclick="openModal('${e._id}','${e.fee}')" style="padding: 4px 10px;background-color: black;color: white;border-radius: 5px;">Book Appoinment</button>
            </div>
          </li>`;
          });
        } catch (error) {
          alert("Somethig went worng");
        }
      };
    </script>

    <script>
      let userId = "";
      let userData = {};

      if (
        localStorage.getItem("user_token") === "" ||
        localStorage.getItem("user_token") === null
      ) {
        window.location.href = "/";
      } else {
        const verify = async () => {
          try {
            const send = await fetch("/user/profile", {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: localStorage.getItem("user_token"),
              },
            });
            const data = await send.json();
            userId = data._id;
            userData = data;
          } catch (error) {
            alert("Somethig went worng");
          }
        };
        verify();
      }
      // Toggle sidebar for mobile
      function toggleSidebar() {
        document.querySelector(".sidebar").classList.toggle("active");
      }

      // Initialize data from localStorage
      let myArray = JSON.parse(localStorage.getItem("data")) || [];

      // Handle send message
      async function handleSend() {
        const messageInput = document.getElementById("chatInput");
        const msg = messageInput.value.trim();

        if (!msg) return; // Don't send empty messages

        // Reset display states
        document.getElementById("beforeMessage").style.display = "none";
        document.getElementById("loader").style.display = "block";
        document.getElementById("messageContainer").style.display = "none";
        document.getElementById("doctorList").innerHTML = "";

        const ids = ["causes", "diet", "medicine", "priority", "sep"];
        ids.map((id) => {
          document.getElementById(id).innerHTML = "";
        });

        try {
          if (userId != "") {
            const response = await fetch("/chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ message: msg, userId }),
            });

            const { message } = await response.json();

            if (message === "Server error") {
              throw new Error("Server error");
            }

            // Update UI with response
            myArray.push(message);
            localStorage.setItem("data", JSON.stringify(myArray));

            // Update lists
            message.cause.forEach((cause) => {
              document.getElementById(
                "causes"
              ).innerHTML += `<li>${cause}</li>`;
            });
            message.diet.forEach((diet) => {
              document.getElementById("diet").innerHTML += `<li>${diet}</li>`;
            });
            message.medicine.forEach((med) => {
              document.getElementById(
                "medicine"
              ).innerHTML += `<li>${med}</li>`;
            });

            // Update priority and specialist
            document.getElementById("priority").textContent =
              message.consultationPriority;
            document.getElementById("sep").textContent = message.specialist;

            // Show results
            document.getElementById("loader").style.display = "none";
            document.getElementById("messageContainer").style.display = "flex";
            messageInput.value = "";
            console.log(message.specialist);

            const doct = await fetch("/doctor/info", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ specialization: message.specialist }),
            });
            const doctData = await doct.json();

            doctData.map((e, i) => {
              document.getElementById("doctorList").innerHTML += `
              <li style="list-style: none;" class="box">
                  <h4>${e.name}, ${e.degrees}</h4>
                  <h5>Cosntation fee: ₹ ${e.fee} </h5>
                  <h5>${e.specialization}</h5>
                  <h5>${e.address}</h5>
                  <div style="padding: 5px 10px; width: 100%;background-color: black;color: white;">Get Appointment</div>                    
              </li>`;
            });
          } else {
            window.location.href = "/";
          }
        } catch (error) {
          console.error(error);
          alert("Something went wrong. Please try again!");
        }
      }

      // Add enter key support for sending messages

      function logout() {
        localStorage.removeItem("user_token");
        window.location.href = "/";
      }
    </script>

    <script>
      function openModal(id, fee) {
        document.getElementById("bookingModal").style.display = "flex";
        document
          .getElementById("bookingModalId")
          .addEventListener("click", (e) => {
            bookAppointment(id, fee);
          });
      }

      // Close Modal
      function closeModal() {
        document.getElementById("bookingModal").style.display = "none";
      }

      // Check if a slot is unavailable
      async function isSlotUnavailable(date, time, id) {
        console.log(id);
        try {
          const selectedSlot = `${date} ${time}`;
          const send = await fetch("/doctor/get", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ _id: id }),
          });
          const res = await send.json();
          const unavailableSlots = res.appointments.map((e) => e.date + e.time);
          return unavailableSlots.includes(selectedSlot);
        } catch (error) {
          console.log(error);
        }
      }

      // Book Appointment
      async function bookAppointment(id, fee) {
        const dateInput = document.getElementById("appointmentDate").value;
        const timeInput = document.getElementById("appointmentTime").value;
        const appointmentMessage =
          document.getElementById("appointmentMessage");

        if (!dateInput || !timeInput) {
          alert("Please select both date and time.");
          return;
        }

        const appointmentDateTime = new Date(`${dateInput}T${timeInput}`);
        const formattedDate = appointmentDateTime.toLocaleDateString();
        const formattedTime = appointmentDateTime.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        // Check if the selected slot is unavailable
        if (!isSlotUnavailable(dateInput, timeInput, id)) {
          appointmentMessage.innerHTML = `<span class="unavailable-slot">This slot is unavailable!</span>`;
        } else {
          try {
            appointmentMessage.textContent = `Appointment booked for: ${formattedDate} at ${formattedTime}`;

            if (userData != {}) {
              const send = await fetch("/user/book/appointment", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  doctorId: id,
                  userId: userId,
                  date: dateInput,
                  time: timeInput,
                }),
              });
              const res = await send.json();
              console.log(res);
              if (res.message == "Appointment booked successfully") {
                window.location.href = res.payRes.data.payment_url;
              } else {
                alert("Payment failed...");
              }
            }
          } catch (error) {
            console.log(error);
          }
        }
      }

      // Close modal when clicking outside of the modal content
      window.onclick = function (event) {
        const modal = document.getElementById("bookingModal");
        if (event.target === modal) {
          closeModal();
        }
      };
    </script>

    <script>
      function getLocation() {
        const locationOutput = document.getElementById("locationOutput");

        // Check if Geolocation is supported by the browser
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
          locationOutput.innerHTML =
            "<p class='error'>Geolocation is not supported by this browser.</p>";
        }
      }

      // Show the position (latitude and longitude) and get the location details
      function showPosition(position) {
        const locationOutput = document.getElementById("locationOutput");
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        const apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10&addressdetails=1`;

        fetch(apiUrl)
          .then((response) => response.json())
          .then((data) => {
            if (data && data.address) {
              const address = data.address;
              console.log(address);

              locationOutput.innerHTML += `
                        <p>${
                          address.city || address.town || address.village || ""
                        }, ${address.state}, ${address.country || ""}</p>
                    `;
            } else {
              locationOutput.innerHTML +=
                "<p class='error'>Could not retrieve location details.</p>";
            }
          })
          .catch((error) => {
            console.error("Error fetching location data:", error);
            locationOutput.innerHTML +=
              "<p class='error'>Error fetching location details.</p>";
          });
      }

      // Handle errors
      function showError(error) {
        const locationOutput = document.getElementById("locationOutput");
        switch (error.code) {
          case error.PERMISSION_DENIED:
            locationOutput.innerHTML =
              "<p class='error'>User denied the request for Geolocation.</p>";
            break;
          case error.POSITION_UNAVAILABLE:
            locationOutput.innerHTML =
              "<p class='error'>Location information is unavailable.</p>";
            break;
          case error.TIMEOUT:
            locationOutput.innerHTML =
              "<p class='error'>The request to get user location timed out.</p>";
            break;
          case error.UNKNOWN_ERROR:
            locationOutput.innerHTML =
              "<p class='error'>An unknown error occurred.</p>";
            break;
        }
      }
      getLocation();
    </script>
  </body>
</html>
